<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>NavegaÃ§Ã£o por Voz - Supermercado</title>

  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; overflow: hidden; }
    a-scene { height: 100vh; width: 100vw; }

    #muteButton {
      position: fixed;
      top: 20px;
      left: 20px;
      padding: 10px 20px;
      font-size: 18px;
      z-index: 1000;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: transform 0.3s ease, background-color 0.3s ease;
    }
    #muteButton.rotating {
      transform: rotate(360deg);
    }

    .mic-wrapper {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 999;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    #mic-button {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 9999px;
      padding: 15px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    .mic-wrapper.recording #mic-button {
      transform: scale(2);
      background-color: #28a745 !important;
    }

    #status {
        position: fixed;
        bottom: 180px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        border-radius: 10px;
        z-index: 998;
        font-size: 16px;
        display: none;
    }

    #footerSocial {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 20px 0;
      display: flex;
      justify-content: center;
      gap: 40px;
      z-index: 999;
      background-color: rgba(0, 0, 0, 0.1);
      box-shadow: 0 0 19.5px rgba(0, 0, 0, 0.47);
    }
    #footerSocial a { display: flex; width: 34.56px; height: 34.56px; }
    #footerSocial svg { width: 34.56px; height: 34.56px; }
  </style>
</head>

<body>
  <button id="muteButton">ðŸ”‡ Ativar Som</button>

  <a-scene vr-mode-ui="enabled: false" arjs='sourceType: webcam; debugUIEnabled: false; trackingMethod: best;'>
    <a-assets>
      <video id="video_chocolate" src="videos/chocolate.mp4" playsinline loop crossOrigin="anonymous"></video>
      <video id="video_acucar" src="videos/acucar.mp4" playsinline loop crossOrigin="anonymous"></video>
      <video id="video_frutas" src="videos/frutas.mp4" playsinline loop crossOrigin="anonymous"></video>
      <video id="video_inicial" src="videos/inicio.mp4" playsinline loop crossOrigin="anonymous"></video>
    </a-assets>

    <a-entity id="video-holder" position="0 1.7 -6"
      animation="property: position; to: 0 1.7 -3.5; dur: 1500; easing: easeOutElastic; startEvents: start-animation">
      <a-video id="main-video" width="3" height="3" src="#video_inicial" autoplay loop look-at="[camera]"></a-video>
    </a-entity>

    <a-entity camera></a-entity>
  </a-scene>

  <div id="status">Ouvindo...</div>
  <div class="mic-wrapper" id="mic-wrapper">
      <button id="mic-button">
          <svg xmlns="http://www.w3.org/2000/svg" id="mic-icon" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" />
          </svg>
      </button>
  </div>

  <div id="footerSocial">
    <a href="#" class="facebook"><svg viewBox="0 0 24 24"><path d="M22 12..."/></svg></a>
    <a href="#" class="instagram"><svg viewBox="0 0 24 24"><path d="M7 2..."/></svg></a>
    <a href="#" class="whatsapp"><svg viewBox="0 0 24 24"><path d="M20.52 3.48..."/></svg></a>
  </div>

  <script>
    const micWrapper = document.getElementById('mic-wrapper');
    const micButton = document.getElementById('mic-button');
    const statusDiv = document.getElementById('status');
    const mainVideo = document.getElementById('main-video');
    const videoHolder = document.getElementById('video-holder');
    const muteButton = document.getElementById('muteButton');
    let isMuted = true;
    let recognitionActive = false;

    const productVideos = {
      'chocolate': '#video_chocolate',
      'aÃ§Ãºcar': '#video_acucar',
      'frutas': '#video_frutas'
    };
    
    function setMuteState(muted) {
        const videoMaterial = mainVideo.components.material;
        if (videoMaterial && videoMaterial.material.map && videoMaterial.material.map.image) {
            videoMaterial.material.map.image.muted = muted;
        }
        isMuted = muted;
        muteButton.textContent = muted ? 'ðŸ”‡ Ativar Som' : 'ðŸ”Š Mudo';
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      const recognition = new SpeechRecognition();
      recognition.lang = 'pt-BR';
      recognition.continuous = false;
      recognition.interimResults = false;

      const startRecognition = () => {
        if (recognitionActive) return;
        try {
            micWrapper.classList.add('recording');
            statusDiv.textContent = "Ouvindo...";
            statusDiv.style.display = 'block';
            recognition.start();
            recognitionActive = true;
        } catch(e) {
            micWrapper.classList.remove('recording');
            statusDiv.style.display = 'none';
        }
      };
      
      const stopRecognition = () => {
        if (!recognitionActive) return;
        micWrapper.classList.remove('recording');
        statusDiv.style.display = 'none';
        recognition.stop();
        recognitionActive = false;
      };
      
      micButton.addEventListener('mousedown', () => {
        navigator.vibrate(50);
        startRecognition();
      });
      micButton.addEventListener('mouseup', stopRecognition);
      micButton.addEventListener('mouseleave', stopRecognition);

      micButton.addEventListener('touchstart', (e) => {
        e.preventDefault();
        navigator.vibrate(50);
        startRecognition();
      });
      micButton.addEventListener('touchend', (e) => {
        e.preventDefault();
        stopRecognition();
      });

      recognition.onend = () => {
        if (recognitionActive) {
            micWrapper.classList.remove('recording');
            statusDiv.style.display = 'none';
            recognitionActive = false;
        }
      };

      recognition.onerror = (event) => {
        statusDiv.textContent = `Erro: ${event.error}`;
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.toLowerCase();
        statusDiv.textContent = `VocÃª disse: "${transcript}"`;

        let foundProduct = false;
        for (const keyword in productVideos) {
          if (transcript.includes(keyword)) {
            const videoSrc = productVideos[keyword];
            mainVideo.setAttribute('src', videoSrc);
            const newVideoEl = document.querySelector(videoSrc);
            newVideoEl.muted = isMuted;
            newVideoEl.play();
            statusDiv.textContent = `Mostrando o corredor de ${keyword}!`;
            foundProduct = true;
            break;
          }
        }

        if (!foundProduct) {
          statusDiv.textContent = `Produto nÃ£o encontrado. Tente "chocolate", "aÃ§Ãºcar" ou "frutas".`;
        }
      };
    } else {
      micWrapper.style.display = 'none';
      statusDiv.textContent = "Seu navegador nÃ£o suporta esta funcionalidade.";
      statusDiv.style.display = 'block';
    }
    
    muteButton.addEventListener('click', () => {
      setMuteState(!isMuted);
      muteButton.classList.add('rotating');
      setTimeout(() => muteButton.classList.remove('rotating'), 300);
    });
    
    document.querySelector('a-scene').addEventListener('loaded', () => {
        videoHolder.emit('start-animation');
        const initialVideo = document.querySelector('#video_inicial');
        initialVideo.muted = true;
        initialVideo.play().catch(() => {});
        setMuteState(true);
    });
  </script>
</body>
</html>
